<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم مدیریت فروشگاه - نسخه ابری</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --primary-dark: #3a0ca3;
            --secondary: #7209b7;
            --accent: #f72585;
            --success: #4bb543;
            --warning: #ffc107;
            --error: #dc3545;
            --info: #17a2b8;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #212529;
            --text-light: #6c757d;
            --border: #dee2e6;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* استایل صفحات */
        .page {
            min-height: calc(100vh - 80px);
            padding: 20px 0;
        }
        
        /* استایل هدر */
        header {
            background: var(--card-bg);
            box-shadow: var(--shadow);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .logo i {
            font-size: 1.8rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: var(--shadow);
        }
        
        /* استایل فرم‌ها */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .auth-header h2 {
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--card-bg);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-danger { 
            background: var(--error); 
            color: white; 
        }
        
        .btn-warning { 
            background: var(--warning); 
            color: white; 
        }
        
        .btn-info { 
            background: var(--info); 
            color: white; 
        }
        
        .btn-google {
            background: white;
            color: #757575;
            border: 1px solid #ddd;
            width: 100%;
            justify-content: center;
        }
        
        .btn-google:hover {
            background: #f8f9fa;
            box-shadow: var(--shadow);
        }
        
        .btn-success:hover, .btn-danger:hover, .btn-warning:hover, .btn-info:hover, .btn-google:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }
        
        .tab:hover:not(.active) {
            color: var(--primary);
        }
        
        /* استایل کارت‌ها */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        /* استایل جداول */
        .table-container {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            color: var(--primary);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 16px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--text);
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .actions button {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        /* استایل نوتیفیکیشن */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.success { background: var(--success); }
        .notification.error { background: var(--error); }
        .notification.warning { background: var(--warning); }
        .notification.info { background: var(--primary); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* استایل مودال */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: var(--primary);
        }
        
        .close-modal {
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-light);
        }
        
        /* استایل وضعیت‌ها */
        .user-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-approved { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        
        /* استایل آیتم‌ها */
        .store-item, .approval-item {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }
        
        .store-item:hover, .approval-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .store-info, .approval-info {
            flex: 1;
        }
        
        .store-name, .approval-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .store-email, .approval-email {
            color: var(--text-light);
            margin-bottom: 8px;
        }
        
        .store-details, .approval-details {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        .store-actions, .approval-actions {
            display: flex;
            gap: 10px;
        }
        
        .password-cell {
            font-family: monospace;
        }
        
        /* استایل تلگرام */
        .telegram-status {
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.9rem;
        }
        
        .telegram-status.active { background: #d4edda; color: #155724; }
        .telegram-status.error { background: #f8d7da; color: #721c24; }
        
        /* استایل چاپ */
        .print-area {
            display: none;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
        
        /* استایل تب‌های کاربر */
        .user-tab, .admin-tab {
            display: block;
        }
        
        .user-tab.hidden, .admin-tab.hidden {
            display: none;
        }
        
        /* استایل لیست محصولات برای فروش */
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        .checkbox-item:last-child {
            border-bottom: none;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
        }
        
        .sold-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .sold-item:last-child {
            border-bottom: none;
        }
        
        .sold-item-info {
            flex: 1;
        }
        
        .sold-item-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .sold-item-details {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        /* استایل محصولات والد و فرزند */
        .parent-item {
            background-color: #f8fafc;
        }
        
        .child-item {
            background-color: #ffffff;
        }
        
        .child-item.hidden {
            display: none;
        }
        
        .toggle-children {
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }
        
        /* استایل لینک‌ها */
        .auth-link {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
        }
        
        .auth-link:hover {
            color: var(--primary-dark);
        }
        
        /* استایل دکمه گوگل */
        .google-btn-container {
            margin: 20px 0;
            text-align: center;
        }
        
        /* استایل ریسپانسیو */
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .store-item, .approval-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .store-actions, .approval-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            th, td {
                padding: 12px 8px;
            }
            
            .actions {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        
        .connection-online { background: var(--success); color: white; }
        .connection-offline { background: var(--error); color: white; }
    </style>
</head>
<body>
    <!-- اعلان وضعیت اتصال -->
    <div id="connectionStatus" class="connection-status hidden">
        <i class="ti ti-wifi"></i>
        <span id="connectionText">در حال اتصال...</span>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="ti ti-shopping-cart"></i>
                    سیستم مدیریت فروشگاه
                </div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <div id="userName"></div>
                    <div class="user-avatar" id="userAvatar"></div>
                    <button id="userProfile" class="btn-info">
                        <i class="ti ti-user"></i>
                        پروفایل
                    </button>
                    <button id="userLogout" class="btn-danger">
                        <i class="ti ti-logout"></i>
                        خروج
                    </button>
                    <button id="adminLogout" class="btn-danger" style="display: none;">
                        <i class="ti ti-logout"></i>
                        خروج مدیر
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- صفحه ورود -->
        <div id="loginPage" class="page">
            <div class="auth-container">
                <div class="auth-header">
                    <h2>ورود به سیستم</h2>
                    <p>سیستم مدیریت چند فروشگاهی</p>
                </div>
                
                <div class="tabs">
                    <div class="tab active" id="userLoginTab">ورود فروشگاه</div>
                    <div class="tab" id="adminLoginTab">ورود مدیر</div>
                </div>
                
                <form id="userLoginForm">
                    <div class="form-group">
                        <label for="userEmail">ایمیل:</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="userPassword">رمز عبور:</label>
                        <input type="password" id="userPassword" required>
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="ti ti-login"></i>
                        ورود
                    </button>
                    
                    <div class="google-btn-container">
                        <div id="g_id_onload"
                            data-client_id="627857769759-7stscotup44r2aqmdpavr615bu20sk99.apps.googleusercontent.com"
                            data-context="signin"
                            data-ux_mode="popup"
                            data-callback="handleGoogleSignIn"
                            data-auto_prompt="false">
                        </div>

                        <div class="g_id_signin"
                            data-type="standard"
                            data-shape="rectangular"
                            data-theme="outline"
                            data-text="signin_with"
                            data-size="large"
                            data-logo_alignment="left">
                        </div>
                    </div>
                </form>
                
                <form id="adminLoginForm" style="display: none;">
                    <div class="form-group">
                        <label for="adminEmail">ایمیل مدیر:</label>
                        <input type="email" id="adminEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">رمز عبور مدیر:</label>
                        <input type="password" id="adminPassword" required>
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="ti ti-login"></i>
                        ورود مدیر
                    </button>
                </form>
                
                <div style="text-align: center; margin-top: 20px;">
                    <span>حساب کاربری ندارید؟ </span>
                    <button id="showRegisterForm" class="btn-info" style="padding: 5px 10px;">
                        <i class="ti ti-user-plus"></i>
                        ثبت نام
                    </button>
                    <div style="margin-top: 10px;">
                        <span class="auth-link" id="forgotPassword">رمز عبور خود را فراموش کرده‌اید؟</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- صفحه ثبت نام -->
        <div id="registerPage" class="page hidden">
            <div class="auth-container">
                <div class="auth-header">
                    <h2>ثبت نام فروشگاه جدید</h2>
                    <p>فرم ثبت نام فروشگاه در سیستم</p>
                </div>
                
                <form id="registerForm">
                    <div class="form-group">
                        <label for="storeName">نام فروشگاه:</label>
                        <input type="text" id="storeName" required>
                    </div>
                    <div class="form-group">
                        <label for="ownerName">نام صاحب فروشگاه:</label>
                        <input type="text" id="ownerName" required>
                    </div>
                    <div class="form-group">
                        <label for="registerEmail">ایمیل:</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">رمز عبور:</label>
                        <input type="password" id="registerPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">تکرار رمز عبور:</label>
                        <input type="password" id="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="ti ti-user-plus"></i>
                        ثبت نام
                    </button>
                </form>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="backToLogin" class="btn-info" style="width: 100%;">
                        <i class="ti ti-arrow-back"></i>
                        بازگشت به صفحه ورود
                    </button>
                </div>
            </div>
        </div>

        <!-- صفحه بازیابی رمز عبور -->
        <div id="forgotPasswordPage" class="page hidden">
            <div class="auth-container">
                <div class="auth-header">
                    <h2>بازیابی رمز عبور</h2>
                    <p>ایمیل خود را وارد کنید تا لینک بازیابی برای شما ارسال شود</p>
                </div>
                
                <form id="forgotPasswordForm">
                    <div class="form-group">
                        <label for="recoveryEmail">ایمیل:</label>
                        <input type="email" id="recoveryEmail" required>
                    </div>
                    <button type="submit" class="btn-primary" style="width: 100%;">
                        <i class="ti ti-send"></i>
                        ارسال لینک بازیابی
                    </button>
                </form>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="backToLoginFromForgot" class="btn-info" style="width: 100%;">
                        <i class="ti ti-arrow-back"></i>
                        بازگشت به صفحه ورود
                    </button>
                </div>
            </div>
        </div>

        <!-- داشبورد کاربر -->
        <div id="userDashboard" class="page hidden">
            <div id="pendingApproval" class="notification warning" style="position: relative; margin-bottom: 20px; display: none;">
                حساب شما در انتظار تأیید مدیر است. پس از تأیید می‌توانید از امکانات سیستم استفاده کنید.
            </div>
            
            <div id="userDashboardContent">
                <div class="user-info-bar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 id="userStoreName">فروشگاه</h2>
                        <div id="userStatus"></div>
                    </div>
                    <div class="user-actions" style="display: flex; gap: 10px;">
                        <button id="backupData" class="btn-info">
                            <i class="ti ti-download"></i>
                            پشتیبان‌گیری
                        </button>
                        <button id="printProducts" class="btn-info">
                            <i class="ti ti-printer"></i>
                            چاپ محصولات
                        </button>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ti ti-package"></i>
                        </div>
                        <div class="stat-number" id="totalProducts">0</div>
                        <div>کل محصولات</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ti ti-category"></i>
                        </div>
                        <div class="stat-number" id="totalCategories">0</div>
                        <div>دسته‌بندی‌ها</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ti ti-box"></i>
                        </div>
                        <div class="stat-number" id="totalParents">0</div>
                        <div>محصولات اصلی</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="ti ti-shopping-cart"></i>
                        </div>
                        <div class="stat-number" id="totalSold">0</div>
                        <div>فروش امروز</div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" data-tab="products">محصولات</div>
                    <div class="tab" data-tab="categories">دسته‌بندی‌ها</div>
                    <div class="tab" data-tab="sales">فروش‌ها</div>
                    <div class="tab" data-tab="settings">تنظیمات</div>
                    <div class="tab" data-tab="profile">پروفایل</div>
                </div>
                
                <!-- تب محصولات -->
                <div id="userProductsTab" class="user-tab">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>لیست محصولات</h3>
                            <div>
                                <button id="exportProducts" class="btn-info">
                                    <i class="ti ti-download"></i>
                                    خروجی
                                </button>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>نام محصول</th>
                                    <th>دسته‌بندی</th>
                                    <th>قیمت (افغانی)</th>
                                    <th>زیرمجموعه</th>
                                    <th>وضعیت</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- محصولات اینجا نمایش داده می‌شوند -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3>افزودن محصول جدید</h3>
                        </div>
                        <form id="productForm" style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="productName">نام محصول:</label>
                                    <input type="text" id="productName" required>
                                </div>
                                <div class="form-group">
                                    <label for="productCategory">دسته‌بندی:</label>
                                    <select id="productCategory" required>
                                        <option value="">انتخاب کنید</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="productPrice">قیمت (افغانی):</label>
                                    <input type="number" id="productPrice" required>
                                </div>
                                <div class="form-group">
                                    <label for="productParent">زیرمجموعه:</label>
                                    <select id="productParent">
                                        <option value="">هیچکدام (محصول اصلی)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="productDescription">توضیحات:</label>
                                <textarea id="productDescription" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="ti ti-plus"></i>
                                افزودن محصول
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- تب دسته‌بندی‌ها -->
                <div id="userCategoriesTab" class="user-tab hidden">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>لیست دسته‌بندی‌ها</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>نام دسته‌بندی</th>
                                    <th>زیرمجموعه</th>
                                    <th>تعداد محصولات</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTableBody">
                                <!-- دسته‌بندی‌ها اینجا نمایش داده می‌شوند -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3>افزودن دسته‌بندی جدید</h3>
                        </div>
                        <form id="categoryForm" style="padding: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="form-group">
                                    <label for="categoryName">نام دسته‌بندی:</label>
                                    <input type="text" id="categoryName" required>
                                </div>
                                <div class="form-group">
                                    <label for="categoryParent">زیرمجموعه:</label>
                                    <select id="categoryParent">
                                        <option value="">هیچکدام (دسته‌بندی اصلی)</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary">
                                <i class="ti ti-plus"></i>
                                افزودن دسته‌بندی
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- تب فروش‌ها -->
                <div id="userSalesTab" class="user-tab hidden">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>فروش‌های امروز</h3>
                        </div>
                        <div id="soldItemsList" style="padding: 20px;">
                            <!-- فروش‌های امروز اینجا نمایش داده می‌شوند -->
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3>ثبت فروش جدید</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div id="productsChecklist">
                                <!-- لیست محصولات برای انتخاب -->
                            </div>
                            <button id="markAsSold" class="btn-success" style="margin-top: 15px;">
                                <i class="ti ti-shopping-cart"></i>
                                ثبت به عنوان فروخته شده
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- تب تنظیمات -->
                <div id="userSettingsTab" class="user-tab hidden">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>تنظیمات تلگرام</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group">
                                <label for="userTelegramToken">توکن ربات تلگرام:</label>
                                <input type="text" id="userTelegramToken" placeholder="توکن ربات تلگرام خود را وارد کنید">
                            </div>
                            <div class="form-group">
                                <label for="userTelegramChatId">Chat ID:</label>
                                <input type="text" id="userTelegramChatId" placeholder="Chat ID خود را وارد کنید">
                            </div>
                            <div id="telegramStatus" class="telegram-status">
                                <span id="telegramStatusText">آماده</span>
                            </div>
                            <button id="saveTelegramSettings" class="btn-primary">
                                <i class="ti ti-device-floppy"></i>
                                ذخیره تنظیمات تلگرام
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3>مدیریت داده‌ها</h3>
                        </div>
                        <div style="padding: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button id="restoreData" class="btn-warning">
                                <i class="ti ti-upload"></i>
                                بازیابی
                            </button>
                            <input type="file" id="restoreFile" accept=".json" style="display: none;">
                            <button id="clearData" class="btn-danger">
                                <i class="ti ti-trash"></i>
                                پاک کردن تمام داده‌ها
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3>گزارش‌گیری</h3>
                        </div>
                        <div style="padding: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button id="printCategories" class="btn-info">
                                <i class="ti ti-printer"></i>
                                چاپ دسته‌بندی‌ها
                            </button>
                            <button id="printSales" class="btn-info">
                                <i class="ti ti-printer"></i>
                                چاپ فروش‌ها
                            </button>
                            <button id="printInventory" class="btn-info">
                                <i class="ti ti-printer"></i>
                                چاپ موجودی
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- تب پروفایل -->
                <div id="userProfileTab" class="user-tab hidden">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>اطلاعات حساب کاربری</h3>
                        </div>
                        <div style="padding: 20px;">
                            <form id="profileForm">
                                <div class="form-group">
                                    <label for="profileStoreName">نام فروشگاه:</label>
                                    <input type="text" id="profileStoreName" required>
                                </div>
                                <div class="form-group">
                                    <label for="profileOwnerName">نام صاحب فروشگاه:</label>
                                    <input type="text" id="profileOwnerName" required>
                                </div>
                                <div class="form-group">
                                    <label for="profileEmail">ایمیل:</label>
                                    <input type="email" id="profileEmail" required>
                                </div>
                                <div class="form-group">
                                    <label for="currentPassword">رمز عبور فعلی:</label>
                                    <input type="password" id="currentPassword">
                                </div>
                                <div class="form-group">
                                    <label for="newPassword">رمز عبور جدید:</label>
                                    <input type="password" id="newPassword">
                                </div>
                                <div class="form-group">
                                    <label for="confirmNewPassword">تکرار رمز عبور جدید:</label>
                                    <input type="password" id="confirmNewPassword">
                                </div>
                                <button type="submit" class="btn-primary">
                                    <i class="ti ti-device-floppy"></i>
                                    ذخیره تغییرات
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- داشبورد مدیر -->
        <div id="adminDashboard" class="page hidden">
            <div class="user-info-bar" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>پنل مدیریت سیستم</h2>
                <div class="user-actions" style="display: flex; gap: 10px;">
                    <button id="backupAllData" class="btn-info">
                        <i class="ti ti-download"></i>
                        پشتیبان‌گیری کلی
                    </button>
                    <button id="createStoreAccount" class="btn-primary">
                        <i class="ti ti-plus"></i>
                        ایجاد فروشگاه
                    </button>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="ti ti-building-store"></i>
                    </div>
                    <div class="stat-number" id="adminTotalStores">0</div>
                    <div>فروشگاه‌ها</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="ti ti-package"></i>
                    </div>
                    <div class="stat-number" id="adminTotalProducts">0</div>
                    <div>کل محصولات</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="ti ti-shopping-cart"></i>
                    </div>
                    <div class="stat-number" id="adminTotalSales">0</div>
                    <div>فروش‌ها</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="ti ti-user-plus"></i>
                    </div>
                    <div class="stat-number" id="adminNewStores">0</div>
                    <div>فروشگاه‌های جدید</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="stores">مدیریت فروشگاه‌ها</div>
                <div class="tab" data-tab="approvals">درخواست‌های تأیید</div>
                <div class="tab" data-tab="credentials">اطلاعات کاربران</div>
                <div class="tab" data-tab="system">تنظیمات سیستم</div>
            </div>
            
            <!-- تب مدیریت فروشگاه‌ها -->
            <div id="adminStoresTab" class="admin-tab">
                <div id="storesList">
                    <!-- لیست فروشگاه‌ها اینجا نمایش داده می‌شوند -->
                </div>
            </div>
            
            <!-- تب درخواست‌های تأیید -->
            <div id="adminApprovalsTab" class="admin-tab hidden">
                <h3 style="margin-bottom: 20px;">درخواست‌های در انتظار تأیید</h3>
                
                <div id="approvalList">
                    <!-- درخواست‌های تأیید اینجا نمایش داده می‌شوند -->
                </div>
            </div>
            
            <!-- تب اطلاعات کاربران -->
            <div id="adminCredentialsTab" class="admin-tab hidden">
                <h3 style="margin-bottom: 20px;">اطلاعات کاربران سیستم</h3>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>نام فروشگاه</th>
                                <th>صاحب فروشگاه</th>
                                <th>ایمیل</th>
                                <th>رمز عبور</th>
                                <th>وضعیت</th>
                                <th>تاریخ ثبت‌نام</th>
                                <th>نوع ورود</th>
                            </tr>
                        </thead>
                        <tbody id="userCredentialsTable">
                            <!-- اطلاعات کاربران اینجا نمایش داده می‌شوند -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- تب تنظیمات سیستم -->
            <div id="adminSystemTab" class="admin-tab hidden">
                <h3 style="margin-bottom: 20px;">تنظیمات و مدیریت سیستم</h3>
                
                <div class="table-container">
                    <div style="padding: 20px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                            <button id="resetAllData" class="btn-danger">
                                <i class="ti ti-refresh"></i>
                                بازنشانی تمام داده‌ها
                            </button>
                            <button id="viewAllData" class="btn-warning">
                                <i class="ti ti-database"></i>
                                مشاهده تمام داده‌ها
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label>اطلاعات مدیر سیستم:</label>
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 8px;">
                                <div><strong>ایمیل:</strong> admin@example.com</div>
                                <div><strong>رمز عبور:</strong> admin123</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال‌ها -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ویرایش محصول</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label for="editProductName">نام محصول:</label>
                    <input type="text" id="editProductName" required>
                </div>
                <div class="form-group">
                    <label for="editProductCategory">دسته‌بندی:</label>
                    <select id="editProductCategory" required>
                        <option value="">انتخاب کنید</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editProductPrice">قیمت (افغانی):</label>
                    <input type="number" id="editProductPrice" required>
                </div>
                <div class="form-group">
                    <label for="editProductParent">زیرمجموعه:</label>
                    <select id="editProductParent">
                        <option value="">هیچکدام (محصول اصلی)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editProductDescription">توضیحات:</label>
                    <textarea id="editProductDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary">
                    <i class="ti ti-device-floppy"></i>
                    ذخیره تغییرات
                </button>
            </form>
        </div>
    </div>

    <div id="createStoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ایجاد حساب فروشگاه جدید</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="createStoreForm">
                <div class="form-group">
                    <label for="newStoreName">نام فروشگاه:</label>
                    <input type="text" id="newStoreName" required>
                </div>
                <div class="form-group">
                    <label for="newOwnerName">نام صاحب فروشگاه:</label>
                    <input type="text" id="newOwnerName" required>
                </div>
                <div class="form-group">
                    <label for="newStoreEmail">ایمیل:</label>
                    <input type="email" id="newStoreEmail" required>
                </div>
                <div class="form-group">
                    <label for="newStorePassword">رمز عبور:</label>
                    <input type="password" id="newStorePassword" required>
                </div>
                <button type="submit" class="btn-primary">
                    <i class="ti ti-plus"></i>
                    ایجاد حساب
                </button>
            </form>
        </div>
    </div>

    <!-- ناحیه چاپ -->
    <div id="printArea" class="print-area"></div>

    <script>
        // سیستم مدیریت چندین فروشگاه - نسخه ابری با سرور واقعی
        (function() {
            'use strict';
            
            // تنظیمات سیستم
            const SYSTEM_CONFIG = {
                adminPhone: '0796304080',
                telegramBotToken: '8207227177:AAEp7JifbIQUCWYscaOxokpvdvTxat7EbQ8',
                telegramChatId: '8106254967',
                version: '2.1.0',
                googleClientId: '627857769759-7stscotup44r2aqmdpavr615bu20sk99.apps.googleusercontent.com',
                apiBaseUrl: 'https://your-real-api.com/api' // آدرس سرور واقعی
            };
            
            // مدیریت وضعیت سیستم
            const SystemState = {
                currentUser: null,
                isAdmin: false,
                users: [],
                pendingApprovals: [],
                adminCredentials: { email: 'admin@example.com', password: 'admin123' },
                token: null,
                isOnline: navigator.onLine,
                
                async init() {
                    try {
                        this.setupConnectionMonitoring();
                        this.setupEventListeners();
                        this.showAppropriatePage();
                    } catch (error) {
                        console.error('خطا در مقداردهی اولیه سیستم:', error);
                        this.showNotification('خطا در راه‌اندازی سیستم', 'error');
                    }
                },
                
                setupConnectionMonitoring() {
                    window.addEventListener('online', () => {
                        this.isOnline = true;
                        this.updateConnectionStatus();
                        this.showNotification('اتصال اینترنت برقرار شد', 'success');
                    });

                    window.addEventListener('offline', () => {
                        this.isOnline = false;
                        this.updateConnectionStatus();
                        this.showNotification('اتصال اینترنت قطع شد', 'error');
                    });

                    this.updateConnectionStatus();
                },

                updateConnectionStatus() {
                    const statusElement = document.getElementById('connectionStatus');
                    const textElement = document.getElementById('connectionText');
                    
                    if (this.isOnline) {
                        statusElement.className = 'connection-status connection-online';
                        textElement.textContent = 'آنلاین';
                        statusElement.classList.remove('hidden');
                    } else {
                        statusElement.className = 'connection-status connection-offline';
                        textElement.textContent = 'آفلاین';
                        statusElement.classList.remove('hidden');
                    }
                },

                async apiCall(endpoint, method = 'GET', data = null) {
                    if (!this.isOnline) {
                        throw new Error('اتصال اینترنت برقرار نیست');
                    }

                    const url = `${SYSTEM_CONFIG.apiBaseUrl}${endpoint}`;
                    const options = {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        signal: AbortSignal.timeout(30000)
                    };

                    if (this.token) {
                        options.headers['Authorization'] = `Bearer ${this.token}`;
                    }

                    if (data && method !== 'GET') {
                        options.body = JSON.stringify(data);
                    }

                    try {
                        const response = await fetch(url, options);
                        
                        if (response.status === 401) {
                            this.logout();
                            throw new Error('جلسه کاربری منقضی شده است');
                        }

                        if (response.status === 403) {
                            throw new Error('دسترسی غیرمجاز');
                        }

                        const result = await response.json();

                        if (!response.ok) {
                            throw new Error(result.error || 'خطای سرور');
                        }

                        return result;
                    } catch (error) {
                        console.error('API Error:', error);
                        
                        if (error.name === 'TimeoutError') {
                            this.showNotification('Timeout: سرور پاسخگو نیست', 'error');
                        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                            this.showNotification('خطا در اتصال به سرور', 'error');
                        } else {
                            this.showNotification(error.message, 'error');
                        }
                        
                        throw error;
                    }
                },
                
                setupEventListeners() {
                    // مدیریت تب‌های ورود
                    document.getElementById('userLoginTab').addEventListener('click', () => this.switchLoginTab('user'));
                    document.getElementById('adminLoginTab').addEventListener('click', () => this.switchLoginTab('admin'));
                    
                    // فرم‌های ورود
                    document.getElementById('userLoginForm').addEventListener('submit', (e) => this.handleUserLogin(e));
                    document.getElementById('adminLoginForm').addEventListener('submit', (e) => this.handleAdminLogin(e));
                    
                    // فرم ثبت‌نام
                    document.getElementById('registerForm').addEventListener('submit', (e) => this.handleRegister(e));
                    
                    // فرم پروفایل
                    document.getElementById('profileForm').addEventListener('submit', (e) => this.handleProfileUpdate(e));
                    
                    // فرم بازیابی رمز عبور
                    document.getElementById('forgotPasswordForm').addEventListener('submit', (e) => this.handleForgotPassword(e));
                    
                    // دکمه‌های ناوبری
                    document.getElementById('showRegisterForm').addEventListener('click', () => this.showRegisterPage());
                    document.getElementById('backToLogin').addEventListener('click', () => this.showLoginPage());
                    document.getElementById('forgotPassword').addEventListener('click', () => this.showForgotPasswordPage());
                    document.getElementById('backToLoginFromForgot').addEventListener('click', () => this.showLoginPage());
                    
                    // دکمه‌های خروج
                    document.getElementById('userLogout').addEventListener('click', () => this.logout());
                    document.getElementById('adminLogout').addEventListener('click', () => this.logout());
                    
                    // دکمه پروفایل
                    document.getElementById('userProfile').addEventListener('click', () => this.switchUserTab('profile'));
                    
                    // فرم‌های مدیریت محصولات و دسته‌بندی‌ها
                    document.getElementById('productForm').addEventListener('submit', (e) => this.handleAddProduct(e));
                    document.getElementById('categoryForm').addEventListener('submit', (e) => this.handleAddCategory(e));
                    document.getElementById('editProductForm').addEventListener('submit', (e) => this.handleEditProduct(e));
                    
                    // دکمه‌های فروش
                    document.getElementById('markAsSold').addEventListener('click', () => this.markProductsAsSold());
                    
                    // دکمه‌های پشتیبان‌گیری
                    document.getElementById('backupData').addEventListener('click', () => this.backupData());
                    document.getElementById('restoreData').addEventListener('click', () => this.triggerRestore());
                    document.getElementById('clearData').addEventListener('click', () => this.clearData());
                    document.getElementById('restoreFile').addEventListener('change', (e) => this.restoreData(e));
                    
                    // دکمه‌های پرینت
                    document.getElementById('printProducts').addEventListener('click', () => this.printProducts());
                    document.getElementById('printCategories').addEventListener('click', () => this.printCategories());
                    document.getElementById('printSales').addEventListener('click', () => this.printSales());
                    document.getElementById('printInventory').addEventListener('click', () => this.printInventory());
                    
                    // تنظیمات تلگرام
                    document.getElementById('saveTelegramSettings').addEventListener('click', () => this.saveTelegramSettings());
                    
                    // مدیریت مودال‌ها
                    document.querySelectorAll('.close-modal').forEach(btn => {
                        btn.addEventListener('click', () => this.closeAllModals());
                    });
                    
                    // مدیریت پنل ادمین
                    document.getElementById('createStoreAccount').addEventListener('click', () => this.openCreateStoreModal());
                    document.getElementById('createStoreForm').addEventListener('submit', (e) => this.handleCreateStore(e));
                    document.getElementById('backupAllData').addEventListener('click', () => this.backupAllData());
                    document.getElementById('resetAllData').addEventListener('click', () => this.resetAllData());
                    document.getElementById('viewAllData').addEventListener('click', () => this.viewAllData());
                    
                    // دکمه خروجی محصولات
                    document.getElementById('exportProducts').addEventListener('click', () => this.exportProducts());
                    
                    // مدیریت تب‌های کاربر و ادمین
                    document.querySelectorAll('#userDashboard .tab').forEach(tab => {
                        tab.addEventListener('click', (e) => {
                            const tabName = e.target.getAttribute('data-tab');
                            this.switchUserTab(tabName);
                        });
                    });
                    
                    document.querySelectorAll('#adminDashboard .tab').forEach(tab => {
                        tab.addEventListener('click', (e) => {
                            const tabName = e.target.getAttribute('data-tab');
                            this.switchAdminTab(tabName);
                        });
                    });
                    
                    // کلیک خارج از مودال برای بستن
                    window.addEventListener('click', (e) => {
                        if (e.target.classList.contains('modal')) {
                            this.closeAllModals();
                        }
                    });
                },
                
                switchLoginTab(tab) {
                    const userTab = document.getElementById('userLoginTab');
                    const adminTab = document.getElementById('adminLoginTab');
                    const userForm = document.getElementById('userLoginForm');
                    const adminForm = document.getElementById('adminLoginForm');
                    
                    if (tab === 'user') {
                        userTab.classList.add('active');
                        adminTab.classList.remove('active');
                        userForm.style.display = 'block';
                        adminForm.style.display = 'none';
                    } else {
                        userTab.classList.remove('active');
                        adminTab.classList.add('active');
                        userForm.style.display = 'none';
                        adminForm.style.display = 'block';
                    }
                },
                
                showAppropriatePage() {
                    const loginPage = document.getElementById('loginPage');
                    const registerPage = document.getElementById('registerPage');
                    const forgotPasswordPage = document.getElementById('forgotPasswordPage');
                    const userDashboard = document.getElementById('userDashboard');
                    const adminDashboard = document.getElementById('adminDashboard');
                    const userInfo = document.getElementById('userInfo');
                    const userLogout = document.getElementById('userLogout');
                    const adminLogout = document.getElementById('adminLogout');
                    
                    // مخفی کردن تمام صفحات
                    loginPage.classList.add('hidden');
                    registerPage.classList.add('hidden');
                    forgotPasswordPage.classList.add('hidden');
                    userDashboard.classList.add('hidden');
                    adminDashboard.classList.add('hidden');
                    userInfo.style.display = 'none';
                    
                    if (this.currentUser) {
                        userInfo.style.display = 'flex';
                        if (this.isAdmin) {
                            adminDashboard.classList.remove('hidden');
                            userLogout.style.display = 'none';
                            adminLogout.style.display = 'block';
                            this.renderAdminDashboard();
                        } else {
                            userDashboard.classList.remove('hidden');
                            userLogout.style.display = 'block';
                            adminLogout.style.display = 'none';
                            this.renderUserDashboard();
                        }
                    } else {
                        loginPage.classList.remove('hidden');
                    }
                },
                
                showLoginPage() {
                    document.getElementById('loginPage').classList.remove('hidden');
                    document.getElementById('registerPage').classList.add('hidden');
                    document.getElementById('forgotPasswordPage').classList.add('hidden');
                },
                
                showRegisterPage() {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('registerPage').classList.remove('hidden');
                    document.getElementById('forgotPasswordPage').classList.add('hidden');
                },
                
                showForgotPasswordPage() {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('registerPage').classList.add('hidden');
                    document.getElementById('forgotPasswordPage').classList.remove('hidden');
                },
                
                async handleUserLogin(e) {
                    e.preventDefault();
                    const email = document.getElementById('userEmail').value;
                    const password = document.getElementById('userPassword').value;

                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading"></div> در حال ورود...';
                    submitBtn.disabled = true;

                    try {
                        const response = await this.apiCall('/auth/login', 'POST', { email, password });
                        this.token = response.token;
                        this.currentUser = response.user;
                        this.isAdmin = false;
                        
                        this.showAppropriatePage();
                        this.showNotification('ورود موفقیت‌آمیز', 'success');
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                },
                
                async handleAdminLogin(e) {
                    e.preventDefault();
                    const email = document.getElementById('adminEmail').value;
                    const password = document.getElementById('adminPassword').value;

                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading"></div> در حال ورود...';
                    submitBtn.disabled = true;

                    try {
                        const response = await this.apiCall('/auth/admin-login', 'POST', { email, password });
                        this.token = response.token;
                        this.currentUser = response.user;
                        this.isAdmin = true;
                        
                        this.showAppropriatePage();
                        this.showNotification('ورود مدیر موفقیت‌آمیز', 'success');
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                },
                
                async handleRegister(e) {
                    e.preventDefault();
                    const storeName = document.getElementById('storeName').value;
                    const ownerName = document.getElementById('ownerName').value;
                    const email = document.getElementById('registerEmail').value;
                    const password = document.getElementById('registerPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    // بررسی تطابق رمز عبور
                    if (password !== confirmPassword) {
                        this.showNotification('رمز عبور و تکرار آن مطابقت ندارند', 'error');
                        return;
                    }

                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading"></div> در حال ثبت‌نام...';
                    submitBtn.disabled = true;
                    
                    try {
                        await this.apiCall('/auth/register', 'POST', {
                            store_name: storeName,
                            owner_name: ownerName,
                            email,
                            password
                        });

                        this.showNotification('ثبت‌نام موفقیت‌آمیز. منتظر تأیید مدیر باشید.', 'success');
                        this.showLoginPage();
                        
                        // ارسال پیام به مدیر
                        this.sendToAdminTelegram(
                            `🏪 درخواست ثبت نام جدید\n\n` +
                            `فروشگاه: ${storeName}\n` +
                            `صاحب: ${ownerName}\n` +
                            `ایمیل: ${email}\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}\n\n` +
                            `لطفا به پنل مدیریت مراجعه کنید.`
                        );
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                },
                
                async handleCreateStore(e) {
                    e.preventDefault();
                    const storeName = document.getElementById('newStoreName').value;
                    const ownerName = document.getElementById('newOwnerName').value;
                    const email = document.getElementById('newStoreEmail').value;
                    const password = document.getElementById('newStorePassword').value;

                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading"></div> در حال ایجاد...';
                    submitBtn.disabled = true;
                    
                    try {
                        await this.apiCall('/admin/stores', 'POST', {
                            store_name: storeName,
                            owner_name: ownerName,
                            email,
                            password
                        });

                        this.closeAllModals();
                        this.showNotification(`حساب فروشگاه ${storeName} با موفقیت ایجاد شد`, 'success');
                        this.renderAdminDashboard();
                        
                        // ارسال پیام به مدیر
                        this.sendToAdminTelegram(
                            `✅ حساب جدید ایجاد شد\n\n` +
                            `فروشگاه: ${storeName}\n` +
                            `صاحب: ${ownerName}\n` +
                            `ایمیل: ${email}\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                },
                
                async handleProfileUpdate(e) {
                    e.preventDefault();
                    if (!this.currentUser) return;
                    
                    const storeName = document.getElementById('profileStoreName').value;
                    const ownerName = document.getElementById('profileOwnerName').value;
                    const email = document.getElementById('profileEmail').value;
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                    
                    // بررسی تغییر رمز عبور
                    if (newPassword) {
                        if (newPassword !== confirmNewPassword) {
                            this.showNotification('رمز عبور جدید و تکرار آن مطابقت ندارند', 'error');
                            return;
                        }
                    }

                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading"></div> در حال ذخیره...';
                    submitBtn.disabled = true;
                    
                    try {
                        await this.apiCall('/auth/profile', 'PUT', {
                            store_name: storeName,
                            owner_name: ownerName,
                            email,
                            currentPassword,
                            newPassword
                        });

                        this.currentUser.store_name = storeName;
                        this.currentUser.owner_name = ownerName;
                        this.currentUser.email = email;
                        
                        this.showNotification('پروفایل با موفقیت به‌روزرسانی شد', 'success');
                        this.renderUserDashboard();
                        
                        // پاک کردن فیلدهای رمز عبور
                        document.getElementById('currentPassword').value = '';
                        document.getElementById('newPassword').value = '';
                        document.getElementById('confirmNewPassword').value = '';
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `👤 پروفایل به‌روزرسانی شد\n\n` +
                            `تغییرات در اطلاعات حساب کاربری شما اعمال شد.\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                },
                
                async handleForgotPassword(e) {
                    e.preventDefault();
                    const email = document.getElementById('recoveryEmail').value;

                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading"></div> در حال ارسال...';
                    submitBtn.disabled = true;
                    
                    try {
                        await this.apiCall('/auth/forgot-password', 'POST', { email });
                        this.showNotification('لینک بازیابی رمز عبور به ایمیل شما ارسال شد', 'success');
                        setTimeout(() => {
                            this.showLoginPage();
                        }, 3000);
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                },
                
                async logout() {
                    try {
                        await this.apiCall('/auth/logout', 'POST');
                    } catch (error) {
                        // ignore logout errors
                    }
                    
                    this.currentUser = null;
                    this.isAdmin = false;
                    this.token = null;
                    
                    this.showAppropriatePage();
                    this.showNotification('خروج موفقیت‌آمیز', 'info');
                },
                
                renderUserDashboard() {
                    if (!this.currentUser) return;
                    
                    // به‌روزرسانی اطلاعات کاربر
                    document.getElementById('userStoreName').textContent = this.currentUser.store_name;
                    document.getElementById('userName').textContent = this.currentUser.store_name;
                    document.getElementById('userAvatar').textContent = this.currentUser.store_name.charAt(0);
                    
                    // نمایش وضعیت تأیید کاربر
                    const userStatusElement = document.getElementById('userStatus');
                    const pendingApprovalElement = document.getElementById('pendingApproval');
                    const userDashboardContent = document.getElementById('userDashboardContent');
                    
                    if (this.currentUser.status === 'approved') {
                        userStatusElement.innerHTML = '<span class="user-status status-approved">تأیید شده</span>';
                        pendingApprovalElement.style.display = 'none';
                        userDashboardContent.style.display = 'block';
                        
                        // به‌روزرسانی آمار
                        this.updateUserStats();
                        
                        // رندر محصولات و دسته‌بندی‌ها
                        this.renderUserProducts();
                        this.renderUserCategories();
                        this.renderUserSoldItems();
                        this.populateUserCategoryDropdowns();
                        this.populateUserParentDropdowns();
                        this.updateUserProductsChecklist();
                        
                        // بارگذاری تنظیمات تلگرام کاربر
                        if (document.getElementById('userTelegramToken')) {
                            document.getElementById('userTelegramToken').value = this.currentUser.telegram_bot_token || '';
                            document.getElementById('userTelegramChatId').value = this.currentUser.telegram_chat_id || '';
                        }
                        
                        // بارگذاری اطلاعات پروفایل
                        if (document.getElementById('profileStoreName')) {
                            document.getElementById('profileStoreName').value = this.currentUser.store_name;
                            document.getElementById('profileOwnerName').value = this.currentUser.owner_name;
                            document.getElementById('profileEmail').value = this.currentUser.email;
                        }
                    } else {
                        userStatusElement.innerHTML = '<span class="user-status status-pending">در انتظار تأیید</span>';
                        pendingApprovalElement.style.display = 'block';
                        userDashboardContent.style.display = 'none';
                    }
                },
                
                async updateUserStats() {
                    if (!this.currentUser) return;
                    
                    try {
                        const response = await this.apiCall('/dashboard/stats');
                        const stats = response.stats;
                        
                        document.getElementById('totalProducts').textContent = stats.totalProducts;
                        document.getElementById('totalCategories').textContent = stats.totalCategories;
                        document.getElementById('totalParents').textContent = stats.parentProducts;
                        document.getElementById('totalSold').textContent = stats.todaySales;
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                async renderUserProducts() {
                    if (!this.currentUser) return;
                    
                    try {
                        const response = await this.apiCall('/products');
                        this.renderProductsTable(response.products);
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                renderProductsTable(products) {
                    const tbody = document.getElementById('productsTableBody');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (!products || products.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-light);">
                                    هیچ محصولی ثبت نشده است
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    const parentProducts = products.filter(p => p.parent_id === null);
                    
                    parentProducts.forEach(product => {
                        const parentRow = document.createElement('tr');
                        parentRow.className = 'parent-item';
                        parentRow.innerHTML = `
                            <td>
                                <button class="toggle-children" data-id="${product.id}">+</button>
                                ${product.name}
                            </td>
                            <td>${product.category_name}</td>
                            <td>${product.price.toLocaleString('fa-IR')}</td>
                            <td>-</td>
                            <td>${product.is_sold ? '<span style="color:red">فروخته شده</span>' : '<span style="color:green">موجود</span>'}</td>
                            <td class="actions">
                                <button class="btn-success" onclick="SystemState.openEditProductModal(${product.id})">ویرایش</button>
                                <button class="btn-danger" onclick="SystemState.deleteUserProduct(${product.id})">حذف</button>
                            </td>
                        `;
                        tbody.appendChild(parentRow);
                        
                        const childProducts = products.filter(p => p.parent_id === product.id);
                        childProducts.forEach(child => {
                            const childRow = document.createElement('tr');
                            childRow.className = 'child-item hidden';
                            childRow.setAttribute('data-parent', product.id);
                            childRow.innerHTML = `
                                <td>→ ${child.name}</td>
                                <td>${child.category_name}</td>
                                <td>${child.price.toLocaleString('fa-IR')}</td>
                                <td>${product.name}</td>
                                <td>${child.is_sold ? '<span style="color:red">فروخته شده</span>' : '<span style="color:green">موجود</span>'}</td>
                                <td class="actions">
                                    <button class="btn-success" onclick="SystemState.openEditProductModal(${child.id})">ویرایش</button>
                                    <button class="btn-danger" onclick="SystemState.deleteUserProduct(${child.id})">حذف</button>
                                </td>
                            `;
                            tbody.appendChild(childRow);
                        });
                    });
                    
                    // اضافه کردن event listener برای دکمه‌های toggle
                    document.querySelectorAll('.toggle-children').forEach(button => {
                        button.addEventListener('click', function() {
                            const parentId = this.getAttribute('data-id');
                            const childRows = document.querySelectorAll(`tr[data-parent="${parentId}"]`);
                            const isHidden = childRows.length > 0 && childRows[0].classList.contains('hidden');
                            
                            childRows.forEach(row => {
                                if (isHidden) {
                                    row.classList.remove('hidden');
                                } else {
                                    row.classList.add('hidden');
                                }
                            });
                            
                            this.textContent = isHidden ? '-' : '+';
                        });
                    });
                },
                
                async renderUserCategories() {
                    if (!this.currentUser) return;
                    
                    try {
                        const response = await this.apiCall('/categories');
                        this.renderCategoriesTable(response.categories);
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                renderCategoriesTable(categories) {
                    const tbody = document.getElementById('categoriesTableBody');
                    if (!tbody) return;
                    
                    tbody.innerHTML = '';
                    
                    if (!categories || categories.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" style="text-align: center; color: var(--text-light);">
                                    هیچ دسته‌بندی ثبت نشده است
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    const parentCategories = categories.filter(c => c.parent_id === null);
                    
                    parentCategories.forEach(category => {
                        const parentRow = document.createElement('tr');
                        parentRow.className = 'parent-item';
                        parentRow.innerHTML = `
                            <td>
                                <button class="toggle-children" data-id="${category.id}">+</button>
                                ${category.name}
                            </td>
                            <td>-</td>
                            <td>${category.product_count || 0}</td>
                            <td class="actions">
                                <button class="btn-success" onclick="SystemState.editUserCategory(${category.id})">ویرایش</button>
                                <button class="btn-danger" onclick="SystemState.deleteUserCategory(${category.id})">حذف</button>
                            </td>
                        `;
                        tbody.appendChild(parentRow);
                        
                        const childCategories = categories.filter(c => c.parent_id === category.id);
                        childCategories.forEach(child => {
                            const childRow = document.createElement('tr');
                            childRow.className = 'child-item hidden';
                            childRow.setAttribute('data-parent', category.id);
                            childRow.innerHTML = `
                                <td>→ ${child.name}</td>
                                <td>${category.name}</td>
                                <td>${child.product_count || 0}</td>
                                <td class="actions">
                                    <button class="btn-success" onclick="SystemState.editUserCategory(${child.id})">ویرایش</button>
                                    <button class="btn-danger" onclick="SystemState.deleteUserCategory(${child.id})">حذف</button>
                                </td>
                            `;
                            tbody.appendChild(childRow);
                        });
                    });
                    
                    // اضافه کردن event listener برای دکمه‌های toggle
                    document.querySelectorAll('.toggle-children').forEach(button => {
                        button.addEventListener('click', function() {
                            const parentId = this.getAttribute('data-id');
                            const childRows = document.querySelectorAll(`tr[data-parent="${parentId}"]`);
                            const isHidden = childRows.length > 0 && childRows[0].classList.contains('hidden');
                            
                            childRows.forEach(row => {
                                if (isHidden) {
                                    row.classList.remove('hidden');
                                } else {
                                    row.classList.add('hidden');
                                }
                            });
                            
                            this.textContent = isHidden ? '-' : '+';
                        });
                    });
                },
                
                async renderUserSoldItems() {
                    if (!this.currentUser) return;
                    
                    try {
                        const response = await this.apiCall('/sales/today');
                        this.renderSoldItems(response.sales);
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                renderSoldItems(sales) {
                    const soldItemsList = document.getElementById('soldItemsList');
                    if (!soldItemsList) return;
                    
                    soldItemsList.innerHTML = '';
                    
                    if (!sales || sales.length === 0) {
                        soldItemsList.innerHTML = '<p style="text-align: center; color: var(--text-light);">هیچ فروشی برای امروز ثبت نشده است</p>';
                        return;
                    }
                    
                    sales.forEach((item, index) => {
                        const soldItem = document.createElement('div');
                        soldItem.className = 'sold-item';
                        soldItem.innerHTML = `
                            <div class="sold-item-info">
                                <div class="sold-item-name">${item.product_name}</div>
                                <div class="sold-item-details">
                                    قیمت: ${item.price.toLocaleString('fa-IR')} افغانی | 
                                    دسته‌بندی: ${item.category_name} |
                                    زمان: ${new Date(item.sold_at).toLocaleTimeString('fa-IR')}
                                </div>
                            </div>
                            <div class="sold-item-actions">
                                <button class="btn-warning" onclick="SystemState.returnProduct(${item.id})">بازگرداندن</button>
                            </div>
                        `;
                        soldItemsList.appendChild(soldItem);
                    });
                },
                
                async populateUserCategoryDropdowns() {
                    if (!this.currentUser) return;
                    
                    try {
                        const response = await this.apiCall('/categories');
                        const categories = response.categories;
                        
                        const categorySelects = [
                            document.getElementById('productCategory'),
                            document.getElementById('editProductCategory'),
                            document.getElementById('categoryParent')
                        ];
                        
                        categorySelects.forEach(select => {
                            if (select) {
                                const currentValue = select.value;
                                select.innerHTML = '<option value="">انتخاب کنید</option>';
                                
                                categories
                                    .filter(c => c.parent_id === null)
                                    .forEach(category => {
                                        const option = document.createElement('option');
                                        option.value = category.id;
                                        option.textContent = category.name;
                                        select.appendChild(option);
                                    });
                                
                                if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                                    select.value = currentValue;
                                }
                            }
                        });
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                async populateUserParentDropdowns() {
                    if (!this.currentUser) return;
                    
                    try {
                        const response = await this.apiCall('/products');
                        const products = response.products;
                        
                        const parentSelects = [
                            document.getElementById('productParent'),
                            document.getElementById('editProductParent')
                        ];
                        
                        parentSelects.forEach(select => {
                            if (select) {
                                const currentValue = select.value;
                                select.innerHTML = '<option value="">هیچکدام (محصول اصلی)</option>';
                                
                                products
                                    .filter(p => p.parent_id === null)
                                    .forEach(product => {
                                        const option = document.createElement('option');
                                        option.value = product.id;
                                        option.textContent = product.name;
                                        select.appendChild(option);
                                    });
                                
                                if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                                    select.value = currentValue;
                                }
                            }
                        });
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                async updateUserProductsChecklist() {
                    if (!this.currentUser) return;
                    
                    try {
                        const response = await this.apiCall('/products/available');
                        this.renderProductsChecklist(response.products);
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                renderProductsChecklist(products) {
                    const checklist = document.getElementById('productsChecklist');
                    if (!checklist) return;
                    
                    checklist.innerHTML = '';
                    
                    if (!products || products.length === 0) {
                        checklist.innerHTML = '<p style="text-align: center; color: var(--text-light);">هیچ محصولی برای فروش موجود نیست</p>';
                        return;
                    }
                    
                    products.forEach(product => {
                        const checkboxItem = document.createElement('div');
                        checkboxItem.className = 'checkbox-item';
                        checkboxItem.innerHTML = `
                            <input type="checkbox" id="product_${product.id}" value="${product.id}">
                            <label for="product_${product.id}">
                                ${product.name} - ${product.price.toLocaleString('fa-IR')} افغانی
                                ${product.parent_id ? ` (زیرمجموعه)` : ''}
                            </label>
                        `;
                        checklist.appendChild(checkboxItem);
                    });
                },
                
                async handleAddProduct(e) {
                    e.preventDefault();
                    if (!this.currentUser) return;
                    
                    const name = document.getElementById('productName').value;
                    const category_id = document.getElementById('productCategory').value;
                    const price = parseInt(document.getElementById('productPrice').value);
                    const parent_id = document.getElementById('productParent').value || null;
                    const description = document.getElementById('productDescription').value;
                    
                    if (!name || !category_id || !price) {
                        this.showNotification('لطفا تمام فیلدهای ضروری را پر کنید', 'error');
                        return;
                    }

                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading"></div> در حال افزودن...';
                    submitBtn.disabled = true;
                    
                    try {
                        await this.apiCall('/products', 'POST', {
                            name,
                            category_id: parseInt(category_id),
                            price,
                            parent_id: parent_id ? parseInt(parent_id) : null,
                            description
                        });

                        this.renderUserDashboard();
                        document.getElementById('productForm').reset();
                        this.showNotification('محصول با موفقیت اضافه شد', 'success');
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `➕ محصول جدید اضافه شد\n\n` +
                            `نام: ${name}\n` +
                            `قیمت: ${price.toLocaleString('fa-IR')} افغانی\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                },
                
                async handleAddCategory(e) {
                    e.preventDefault();
                    if (!this.currentUser) return;
                    
                    const name = document.getElementById('categoryName').value;
                    const parent_id = document.getElementById('categoryParent').value || null;
                    
                    if (!name) {
                        this.showNotification('لطفا نام دسته‌بندی را وارد کنید', 'error');
                        return;
                    }

                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading"></div> در حال افزودن...';
                    submitBtn.disabled = true;
                    
                    try {
                        await this.apiCall('/categories', 'POST', {
                            name,
                            parent_id: parent_id ? parseInt(parent_id) : null
                        });

                        this.renderUserDashboard();
                        document.getElementById('categoryForm').reset();
                        this.showNotification('دسته‌بندی با موفقیت اضافه شد', 'success');
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `📁 دسته‌بندی جدید اضافه شد\n\n` +
                            `نام: ${name}\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                },
                
                async openEditProductModal(productId) {
                    if (!this.currentUser) return;
                    
                    try {
                        const response = await this.apiCall(`/products/${productId}`);
                        const product = response.product;
                        
                        document.getElementById('editProductId').value = product.id;
                        document.getElementById('editProductName').value = product.name;
                        document.getElementById('editProductCategory').value = product.category_id;
                        document.getElementById('editProductPrice').value = product.price;
                        document.getElementById('editProductParent').value = product.parent_id || '';
                        document.getElementById('editProductDescription').value = product.description || '';
                        
                        // مطمئن شویم dropdownها پر شده‌اند
                        await this.populateUserCategoryDropdowns();
                        await this.populateUserParentDropdowns();
                        
                        document.getElementById('editProductModal').style.display = 'flex';
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                async handleEditProduct(e) {
                    e.preventDefault();
                    if (!this.currentUser) return;
                    
                    const productId = parseInt(document.getElementById('editProductId').value);
                    const name = document.getElementById('editProductName').value;
                    const category_id = document.getElementById('editProductCategory').value;
                    const price = parseInt(document.getElementById('editProductPrice').value);
                    const parent_id = document.getElementById('editProductParent').value || null;
                    const description = document.getElementById('editProductDescription').value;
                    
                    if (!name || !category_id || !price) {
                        this.showNotification('لطفا تمام فیلدهای ضروری را پر کنید', 'error');
                        return;
                    }

                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading"></div> در حال ذخیره...';
                    submitBtn.disabled = true;
                    
                    try {
                        await this.apiCall(`/products/${productId}`, 'PUT', {
                            name,
                            category_id: parseInt(category_id),
                            price,
                            parent_id: parent_id ? parseInt(parent_id) : null,
                            description
                        });

                        this.renderUserDashboard();
                        this.closeAllModals();
                        this.showNotification('محصول با موفقیت ویرایش شد', 'success');
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `✏️ محصول ویرایش شد\n\n` +
                            `نام: ${name}\n` +
                            `قیمت جدید: ${price.toLocaleString('fa-IR')} افغانی\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                },
                
                async deleteUserProduct(productId) {
                    if (!this.currentUser) return;
                    
                    if (!confirm('آیا از حذف این محصول اطمینان دارید؟')) return;
                    
                    try {
                        await this.apiCall(`/products/${productId}`, 'DELETE');
                        this.renderUserDashboard();
                        this.showNotification('محصول با موفقیت حذف شد', 'success');
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `🗑️ محصول حذف شد\n\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                async deleteUserCategory(categoryId) {
                    if (!this.currentUser) return;
                    
                    if (!confirm('آیا از حذف این دسته‌بندی اطمینان دارید؟ محصولات مرتبط نیز حذف خواهند شد.')) return;
                    
                    try {
                        await this.apiCall(`/categories/${categoryId}`, 'DELETE');
                        this.renderUserDashboard();
                        this.showNotification('دسته‌بندی با موفقیت حذف شد', 'success');
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                async markProductsAsSold() {
                    if (!this.currentUser) return;
                    
                    const checkboxes = document.querySelectorAll('#productsChecklist input[type="checkbox"]:checked');
                    if (checkboxes.length === 0) {
                        this.showNotification('هیچ محصولی انتخاب نشده است', 'warning');
                        return;
                    }
                    
                    const productIds = Array.from(checkboxes).map(checkbox => parseInt(checkbox.value));
                    
                    try {
                        await this.apiCall('/sales', 'POST', { product_ids: productIds });
                        this.renderUserDashboard();
                        
                        this.showNotification(
                            `${productIds.length} محصول با موفقیت به عنوان فروخته شده ثبت شد`,
                            'success'
                        );
                        
                        // ارسال پیام به تلگرام
                        if (productIds.length === 1) {
                            this.sendToUserTelegram(
                                `💰 فروش جدید ثبت شد\n\n` +
                                `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                            );
                        } else {
                            this.sendToUserTelegram(
                                `💰 فروش چندگانه ثبت شد\n\n` +
                                `تعداد محصولات: ${productIds.length}\n` +
                                `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                            );
                        }
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                async returnProduct(saleId) {
                    if (!this.currentUser) return;
                    
                    if (!confirm('آیا از بازگرداندن این محصول اطمینان دارید؟')) return;
                    
                    try {
                        await this.apiCall(`/sales/${saleId}/return`, 'POST');
                        this.renderUserDashboard();
                        this.showNotification('محصول با موفقیت بازگردانده شد', 'success');
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `↩️ محصول بازگردانده شد\n\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },
                
                // بقیه متدها دقیقاً مانند کد اصلی شما...
                // فقط localStorage حذف شده و همه چیز از سرور لود می‌شود

                async renderAdminDashboard() {
                    try {
                        const [storesResponse, pendingResponse, statsResponse] = await Promise.all([
                            this.apiCall('/admin/stores'),
                            this.apiCall('/admin/pending-users'),
                            this.apiCall('/admin/stats')
                        ]);

                        this.renderStoresList(storesResponse.stores);
                        this.renderApprovalList(pendingResponse.users);
                        this.updateAdminStats(statsResponse.stats);
                        this.renderUserCredentials();
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },

                renderStoresList(stores) {
                    const container = document.getElementById('storesList');
                    container.innerHTML = '';

                    if (!stores || stores.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">هیچ فروشگاهی ثبت‌نام نکرده است</p>';
                        return;
                    }

                    stores.forEach(store => {
                        const storeItem = document.createElement('div');
                        storeItem.className = 'store-item';
                        storeItem.innerHTML = `
                            <div class="store-info">
                                <div class="store-name">${store.store_name}</div>
                                <div class="store-email">${store.email} - ${store.owner_name}</div>
                                <div class="store-details">
                                    محصولات: ${store.products_count || 0} | 
                                    فروش: ${store.sales_count || 0} | 
                                    وضعیت: ${store.status === 'approved' ? 'تأیید شده' : 'در انتظار'} | 
                                    تاریخ ثبت‌نام: ${new Date(store.created_at).toLocaleDateString('fa-IR')}
                                </div>
                            </div>
                            <div class="store-actions">
                                <button class="btn-info" onclick="SystemState.viewStoreDetails(${store.id})">مشاهده</button>
                                ${store.status === 'pending' ? `
                                    <button class="btn-success" onclick="SystemState.approveStore(${store.id})">تأیید</button>
                                    <button class="btn-danger" onclick="SystemState.rejectStore(${store.id})">رد</button>
                                ` : `
                                    <button class="btn-warning" onclick="SystemState.suspendStore(${store.id})">تعلیق</button>
                                `}
                            </div>
                        `;
                        container.appendChild(storeItem);
                    });
                },

                renderApprovalList(users) {
                    const container = document.getElementById('approvalList');
                    container.innerHTML = '';

                    if (!users || users.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--text-light);">هیچ درخواست تأییدی در انتظار نیست</p>';
                        return;
                    }

                    users.forEach(user => {
                        const approvalItem = document.createElement('div');
                        approvalItem.className = 'approval-item';
                        approvalItem.innerHTML = `
                            <div class="approval-info">
                                <div class="store-name">${user.store_name}</div>
                                <div class="store-email">${user.email} - ${user.owner_name}</div>
                                <div class="store-details">
                                    تاریخ ثبت‌نام: ${new Date(user.created_at).toLocaleDateString('fa-IR')} | 
                                    نوع ورود: ${user.google_id ? 'گوگل' : 'ایمیل/رمز عبور'}
                                </div>
                            </div>
                            <div class="approval-actions">
                                <button class="btn-success" onclick="SystemState.approveStore(${user.id})">تأیید</button>
                                <button class="btn-danger" onclick="SystemState.rejectStore(${user.id})">رد</button>
                            </div>
                        `;
                        container.appendChild(approvalItem);
                    });
                },

                async approveStore(storeId) {
                    try {
                        await this.apiCall(`/admin/stores/${storeId}/approve`, 'PUT');
                        this.showNotification('فروشگاه با موفقیت تأیید شد', 'success');
                        this.renderAdminDashboard();
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },

                async rejectStore(storeId) {
                    try {
                        await this.apiCall(`/admin/stores/${storeId}/reject`, 'PUT');
                        this.showNotification('فروشگاه با موفقیت رد شد', 'success');
                        this.renderAdminDashboard();
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },

                async suspendStore(storeId) {
                    if (confirm('آیا از تعلیق این فروشگاه اطمینان دارید؟')) {
                        try {
                            await this.apiCall(`/admin/stores/${storeId}/suspend`, 'PUT');
                            this.showNotification('فروشگاه با موفقیت تعلیق شد', 'success');
                            this.renderAdminDashboard();
                        } catch (error) {
                            // خطا قبلاً در apiCall مدیریت شده
                        }
                    }
                },

                updateAdminStats(stats) {
                    document.getElementById('adminTotalStores').textContent = stats.totalStores;
                    document.getElementById('adminTotalProducts').textContent = stats.totalProducts;
                    document.getElementById('adminTotalSales').textContent = stats.totalSales;
                    document.getElementById('adminNewStores').textContent = stats.pendingStores;
                },

                async renderUserCredentials() {
                    try {
                        const response = await this.apiCall('/admin/users');
                        this.renderCredentialsTable(response.users);
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },

                renderCredentialsTable(users) {
                    const tbody = document.getElementById('userCredentialsTable');
                    if (!tbody) return;

                    tbody.innerHTML = '';

                    if (!users || users.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; color: var(--text-light);">
                                    هیچ کاربری ثبت‌نام نکرده است
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.store_name}</td>
                            <td>${user.owner_name}</td>
                            <td>${user.email}</td>
                            <td class="password-cell">${user.password || '---'}</td>
                            <td><span class="user-status ${user.status === 'approved' ? 'status-approved' : 'status-pending'}">${user.status === 'approved' ? 'تأیید شده' : 'در انتظار'}</span></td>
                            <td>${new Date(user.created_at).toLocaleDateString('fa-IR')}</td>
                            <td>${user.google_id ? 'گوگل' : 'ایمیل/رمز عبور'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                },

                // بقیه متدهای اصلی شما...
                // ...

                closeAllModals() {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                },

                switchUserTab(tabName) {
                    // مخفی کردن تمام تب‌ها
                    document.querySelectorAll('.user-tab').forEach(tab => {
                        tab.classList.add('hidden');
                    });
                    
                    // غیرفعال کردن تمام تب‌ها
                    document.querySelectorAll('#userDashboard .tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // نمایش تب انتخاب شده
                    const targetTab = document.getElementById(`user${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
                    if (targetTab) {
                        targetTab.classList.remove('hidden');
                    }
                    
                    // فعال کردن تب انتخاب شده
                    const activeTab = document.querySelector(`#userDashboard .tab[data-tab="${tabName}"]`);
                    if (activeTab) {
                        activeTab.classList.add('active');
                    }
                },
                
                switchAdminTab(tabName) {
                    // مخفی کردن تمام تب‌ها
                    document.querySelectorAll('.admin-tab').forEach(tab => {
                        tab.classList.add('hidden');
                    });
                    
                    // غیرفعال کردن تمام تب‌ها
                    document.querySelectorAll('#adminDashboard .tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // نمایش تب انتخاب شده
                    const targetTab = document.getElementById(`admin${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`);
                    if (targetTab) {
                        targetTab.classList.remove('hidden');
                    }
                    
                    // فعال کردن تب انتخاب شده
                    const activeTab = document.querySelector(`#adminDashboard .tab[data-tab="${tabName}"]`);
                    if (activeTab) {
                        activeTab.classList.add('active');
                    }
                },

                openCreateStoreModal() {
                    document.getElementById('createStoreModal').style.display = 'flex';
                },

                async backupData() {
                    if (!this.currentUser) return;
                    
                    try {
                        const response = await this.apiCall('/backup');
                        const dataStr = JSON.stringify(response.data, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        
                        const url = URL.createObjectURL(dataBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `backup-${this.currentUser.store_name}-${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        this.showNotification('پشتیبان با موفقیت دانلود شد', 'success');
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },

                triggerRestore() {
                    document.getElementById('restoreFile').click();
                },

                async restoreData(e) {
                    if (!this.currentUser) return;
                    
                    const file = e.target.files[0];
                    if (!file) return;

                    const submitBtn = document.getElementById('restoreData');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading"></div> در حال بازیابی...';
                    submitBtn.disabled = true;
                    
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            await this.apiCall('/restore', 'POST', { backup_data: data });
                            this.showNotification('داده‌ها با موفقیت بازیابی شدند', 'success');
                            this.renderUserDashboard();
                        } catch (error) {
                            // خطا قبلاً در apiCall مدیریت شده
                        } finally {
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                            e.target.value = '';
                        }
                    };
                    reader.readAsText(file);
                },

                async clearData() {
                    if (!this.currentUser) return;
                    
                    if (!confirm('آیا از پاک کردن تمام داده های خود اطمینان دارید؟ این عمل غیرقابل برگشت است.')) return;

                    const submitBtn = document.getElementById('clearData');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<div class="loading"></div> در حال پاک کردن...';
                    submitBtn.disabled = true;
                    
                    try {
                        await this.apiCall('/data/clear', 'POST');
                        this.showNotification('تمامی داده ها پاک شدند', 'success');
                        this.renderUserDashboard();
                        
                        // ارسال پیام به تلگرام
                        this.sendToUserTelegram(
                            `🔄 داده ها بازنشانی شدند\n\n` +
                            `تمامی محصولات، دسته‌بندی‌ها و تاریخچه فروش پاک شدند.\n` +
                            `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                        );
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                },

                async saveTelegramSettings() {
                    if (!this.currentUser) return;
                    
                    const token = document.getElementById('userTelegramToken').value;
                    const chatId = document.getElementById('userTelegramChatId').value;
                    
                    try {
                        await this.apiCall('/settings/telegram', 'PUT', {
                            telegram_bot_token: token,
                            telegram_chat_id: chatId
                        });

                        this.currentUser.telegram_bot_token = token;
                        this.currentUser.telegram_chat_id = chatId;
                        
                        this.showNotification('تنظیمات تلگرام ذخیره شد', 'success');
                        
                        // تست ارسال پیام
                        if (token && chatId) {
                            this.sendToUserTelegram('✅ تنظیمات تلگرام با موفقیت ذخیره شد. این پیام تستی است.');
                        }
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },

                async sendToUserTelegram(message) {
                    if (!this.currentUser || !this.currentUser.telegram_bot_token || !this.currentUser.telegram_chat_id) {
                        this.updateTelegramStatus('تنظیمات تلگرام کاربر تعریف نشده است', 'error');
                        return false;
                    }
                    
                    try {
                        const url = `https://api.telegram.org/bot${this.currentUser.telegram_bot_token}/sendMessage`;
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chat_id: this.currentUser.telegram_chat_id,
                                text: message,
                                parse_mode: 'HTML'
                            })
                        });
                        
                        const result = await response.json();
                        if (result.ok) {
                            this.updateTelegramStatus('پیام ارسال شد', 'active');
                            return true;
                        } else {
                            this.updateTelegramStatus('خطا در ارسال: ' + result.description, 'error');
                            return false;
                        }
                    } catch (error) {
                        console.error('خطا در ارسال به تلگرام:', error);
                        this.updateTelegramStatus('خطا در اتصال به تلگرام', 'error');
                        return false;
                    }
                },
                
                async sendToAdminTelegram(message) {
                    try {
                        const url = `https://api.telegram.org/bot${SYSTEM_CONFIG.telegramBotToken}/sendMessage`;
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                chat_id: SYSTEM_CONFIG.telegramChatId,
                                text: message,
                                parse_mode: 'HTML'
                            })
                        });
                        
                        const result = await response.json();
                        return result.ok;
                    } catch (error) {
                        console.error('خطا در ارسال به تلگرام مدیر:', error);
                        return false;
                    }
                },
                
                updateTelegramStatus(message, type = '') {
                    const statusElement = document.getElementById('telegramStatusText');
                    const statusContainer = document.getElementById('telegramStatus');
                    
                    if (statusElement && statusContainer) {
                        statusElement.textContent = message;
                        statusContainer.className = 'telegram-status';
                        if (type) {
                            statusContainer.classList.add(type);
                        }
                        
                        // بعد از 5 ثانیه وضعیت را به حالت عادی برگردان
                        setTimeout(() => {
                            statusElement.textContent = 'آماده';
                            statusContainer.className = 'telegram-status';
                        }, 5000);
                    }
                },

                // متدهای viewStoreDetails, editUserCategory و سایر متدهای اصلی...
                viewStoreDetails(storeId) {
                    // پیاده‌سازی مشاهده جزئیات فروشگاه
                    this.showNotification('قابلیت مشاهده جزئیات فروشگاه به زودی اضافه خواهد شد', 'info');
                },

                async editUserCategory(categoryId) {
                    const newName = prompt('نام جدید دسته‌بندی را وارد کنید:');
                    if (newName && newName.trim() !== '') {
                        try {
                            await this.apiCall(`/categories/${categoryId}`, 'PUT', { name: newName.trim() });
                            this.renderUserDashboard();
                            this.showNotification('دسته‌بندی با موفقیت ویرایش شد', 'success');
                            
                            // ارسال پیام به تلگرام
                            this.sendToUserTelegram(
                                `✏️ دسته‌بندی ویرایش شد\n\n` +
                                `نام جدید: ${newName}\n` +
                                `تاریخ: ${new Date().toLocaleDateString('fa-IR')}`
                            );
                        } catch (error) {
                            this.showNotification('خطا در ویرایش دسته‌بندی', 'error');
                        }
                    }
                },

                async backupAllData() {
                    try {
                        const response = await this.apiCall('/admin/backup-all');
                        const dataStr = JSON.stringify(response.data, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        
                        const url = URL.createObjectURL(dataBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `backup-all-${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        this.showNotification('پشتیبان از تمام داده ها با موفقیت دانلود شد', 'success');
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },

                async resetAllData() {
                    if (confirm('آیا از بازنشانی تمام داده های سیستم اطمینان دارید؟ این عمل تمام کاربران، محصولات و تاریخچه را پاک می‌کند و غیرقابل برگشت است.')) {
                        try {
                            await this.apiCall('/admin/reset-all', 'POST');
                            this.showNotification('تمامی داده های سیستم بازنشانی شدند', 'success');
                            this.renderAdminDashboard();
                        } catch (error) {
                            // خطا قبلاً در apiCall مدیریت شده
                        }
                    }
                },

                async viewAllData() {
                    try {
                        const response = await this.apiCall('/admin/all-data');
                        alert('داده‌های سیستم:\n\n' + JSON.stringify(response.data, null, 2));
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },

                async exportProducts() {
                    if (!this.currentUser) return;
                    
                    try {
                        const response = await this.apiCall('/products/export');
                        const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + response.csv;
                        
                        const encodedUri = encodeURI(csvContent);
                        const link = document.createElement("a");
                        link.setAttribute("href", encodedUri);
                        link.setAttribute("download", `محصولات_${this.currentUser.store_name}_${new Date().toISOString().split('T')[0]}.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        this.showNotification('خروجی CSV با موفقیت دانلود شد', 'success');
                    } catch (error) {
                        // خطا قبلاً در apiCall مدیریت شده
                    }
                },

                // متدهای پرینت (همانند کد اصلی)
                printProducts() {
                    // پیاده‌سازی پرینت محصولات
                    this.showNotification('قابلیت پرینت به زودی اضافه خواهد شد', 'info');
                },

                printCategories() {
                    // پیاده‌سازی پرینت دسته‌بندی‌ها
                    this.showNotification('قابلیت پرینت به زودی اضافه خواهد شد', 'info');
                },

                printSales() {
                    // پیاده‌سازی پرینت فروش‌ها
                    this.showNotification('قابلیت پرینت به زودی اضافه خواهد شد', 'info');
                },

                printInventory() {
                    // پیاده‌سازی پرینت موجودی
                    this.showNotification('قابلیت پرینت به زودی اضافه خواهد شد', 'info');
                },

                showNotification(message, type = 'info') {
                    // حذف نوتیفیکیشن‌های قبلی
                    document.querySelectorAll('.notification').forEach(notification => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    });
                    
                    const notification = document.createElement('div');
                    notification.className = `notification ${type}`;
                    notification.innerHTML = `
                        <i class="ti ti-${type === 'success' ? 'circle-check' : type === 'error' ? 'alert-circle' : type === 'warning' ? 'alert-triangle' : 'info-circle'}"></i>
                        ${message}
                    `;
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 5000);
                }
            };

            // تابع callback برای ورود گوگل
            window.handleGoogleSignIn = function(response) {
                console.log('پاسخ احراز هویت گوگل:', response);
                
                // ارسال اطلاعات گوگل به سرور
                const credential = response.credential;
                
                fetch(`${SYSTEM_CONFIG.apiBaseUrl}/auth/google`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ credential })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.token) {
                        SystemState.token = data.token;
                        SystemState.currentUser = data.user;
                        SystemState.isAdmin = data.user.role === 'admin';
                        SystemState.showAppropriatePage();
                        
                        if (data.user.approved) {
                            SystemState.showNotification('ورود با گوگل موفقیت‌آمیز بود', 'success');
                        } else {
                            SystemState.showNotification('حساب شما در انتظار تأیید مدیر است', 'warning');
                        }
                    } else {
                        SystemState.showNotification(data.error || 'خطا در ورود با گوگل', 'error');
                    }
                })
                .catch(error => {
                    console.error('خطا در ورود گوگل:', error);
                    SystemState.showNotification('خطا در ارتباط با سرور', 'error');
                });
            };

            // مقداردهی اولیه سیستم وقتی DOM بارگذاری شد
            document.addEventListener('DOMContentLoaded', function() {
                SystemState.init();
            });

            // در دسترس قرار دادن SystemState در سطح جهانی برای استفاده از توابع در event handlerها
            window.SystemState = SystemState;
        })();
    </script>
</body>
</html>
